name: Verify DuckDB Build Fix

on:
  push:
    branches:
      - "claude/*"
  pull_request:
    branches:
      - main

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: editors/vscode/pnpm-lock.yaml
      - run: pnpm install --shamefully-hoist --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Download duckdb binary for target platform
        run: node download-duckdb-binary.js
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: x64
      - name: Verify duckdb binary was downloaded
        run: |
          ls -la dist/binding/
          file dist/binding/duckdb.node
      - run: pnpm exec vsce package --no-dependencies --target linux-x64
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: x64
      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: "./editors/vscode/*.vsix"

  test-bundle:
    runs-on: ubuntu-latest
    needs: build-linux-x64
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
      - uses: actions/download-artifact@v4
        with:
          name: linux-x64
          path: ./editors/vscode/
      - name: Test Linux x64 extension bundle
        run: |
          ls -la *.vsix
          node test-extension-bundle.js *.vsix

  # Also test a cross-platform build (arm64 on x64 runner)
  build-linux-arm64:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: editors/vscode/pnpm-lock.yaml
      - run: pnpm install --shamefully-hoist --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Download duckdb binary for target platform (cross-compile)
        run: node download-duckdb-binary.js
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: arm64
      - name: Verify duckdb binary was downloaded for arm64
        run: |
          ls -la dist/binding/
          file dist/binding/duckdb.node
          # Verify it's actually an ARM64 binary
          file dist/binding/duckdb.node | grep -i "aarch64\|arm64"
      - run: pnpm exec vsce package --no-dependencies --target linux-arm64
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: arm64
      - uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: "./editors/vscode/*.vsix"

  test-arm64-bundle:
    runs-on: ubuntu-latest
    needs: build-linux-arm64
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
      - uses: actions/download-artifact@v4
        with:
          name: linux-arm64
          path: ./editors/vscode/
      - name: Test Linux arm64 extension bundle
        run: |
          ls -la *.vsix
          node test-extension-bundle.js *.vsix
