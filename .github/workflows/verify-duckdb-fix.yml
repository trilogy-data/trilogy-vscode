name: Verify DuckDB Build Fix

on:
  push:
    branches:
      - "claude/*"
  pull_request:
    branches:
      - main

jobs:
  # Test the full build pipeline for linux-x64 (native build)
  build-linux-x64:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: editors/vscode/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --shamefully-hoist --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download duckdb binary for target platform
        run: node download-duckdb-binary.js
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: x64

      - name: Verify duckdb binary was downloaded
        run: |
          echo "=== Checking dist/binding directory ==="
          ls -la dist/binding/
          echo "=== File type ==="
          file dist/binding/duckdb.node
          echo "=== File size ==="
          stat --printf="Size: %s bytes\n" dist/binding/duckdb.node

      - name: Package extension
        run: pnpm exec vsce package --no-dependencies --target linux-x64
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: x64

      - name: List built artifacts
        run: ls -la *.vsix

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: "./editors/vscode/*.vsix"

  # Test cross-platform build (arm64 on x64 runner)
  build-linux-arm64:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: editors/vscode/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --shamefully-hoist --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download duckdb binary for target platform (cross-compile)
        run: node download-duckdb-binary.js
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: arm64

      - name: Verify duckdb binary was downloaded for arm64
        run: |
          echo "=== Checking dist/binding directory ==="
          ls -la dist/binding/
          echo "=== File type ==="
          file dist/binding/duckdb.node
          echo "=== Verify it's actually ARM64 ==="
          file dist/binding/duckdb.node | grep -E "aarch64|ARM64|arm64" || (echo "ERROR: Binary is not ARM64!" && exit 1)

      - name: Package extension
        run: pnpm exec vsce package --no-dependencies --target linux-arm64
        env:
          TARGET_PLATFORM: linux
          TARGET_ARCH: arm64

      - uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: "./editors/vscode/*.vsix"

  # Test macOS arm64 cross-platform build
  build-darwin-arm64:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: editors/vscode/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --shamefully-hoist --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download duckdb binary for darwin-arm64
        run: node download-duckdb-binary.js
        env:
          TARGET_PLATFORM: darwin
          TARGET_ARCH: arm64

      - name: Verify duckdb binary was downloaded for darwin-arm64
        run: |
          echo "=== Checking dist/binding directory ==="
          ls -la dist/binding/
          echo "=== File type ==="
          file dist/binding/duckdb.node
          echo "=== Verify it's Mach-O ARM64 ==="
          file dist/binding/duckdb.node | grep -E "Mach-O.*arm64" || (echo "ERROR: Binary is not Mach-O ARM64!" && exit 1)

      - name: Package extension
        run: pnpm exec vsce package --no-dependencies --target darwin-arm64
        env:
          TARGET_PLATFORM: darwin
          TARGET_ARCH: arm64

      - uses: actions/upload-artifact@v4
        with:
          name: darwin-arm64
          path: "./editors/vscode/*.vsix"

  # Test Windows build
  build-win32-x64:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          cache-dependency-path: editors/vscode/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --shamefully-hoist --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download duckdb binary for win32-x64
        run: node download-duckdb-binary.js
        env:
          TARGET_PLATFORM: win32
          TARGET_ARCH: x64

      - name: Verify duckdb binary was downloaded
        run: |
          dir dist\binding\
          if (Test-Path dist\binding\duckdb.node) { Write-Host "duckdb.node exists" } else { exit 1 }

      - name: Package extension
        run: pnpm exec vsce package --no-dependencies --target win32-x64
        env:
          TARGET_PLATFORM: win32
          TARGET_ARCH: x64

      - uses: actions/upload-artifact@v4
        with:
          name: win32-x64
          path: "./editors/vscode/*.vsix"

  # Validate the linux-x64 bundle
  test-linux-x64-bundle:
    runs-on: ubuntu-latest
    needs: build-linux-x64
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
      - uses: actions/download-artifact@v4
        with:
          name: linux-x64
          path: ./editors/vscode/
      - name: Test Linux x64 extension bundle
        run: |
          echo "=== Downloaded artifacts ==="
          ls -la *.vsix
          echo "=== Running bundle validation ==="
          node test-extension-bundle.js *.vsix

  # Validate the linux-arm64 bundle
  test-linux-arm64-bundle:
    runs-on: ubuntu-latest
    needs: build-linux-arm64
    defaults:
      run:
        working-directory: ./editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
      - uses: actions/download-artifact@v4
        with:
          name: linux-arm64
          path: ./editors/vscode/
      - name: Test Linux arm64 extension bundle
        run: |
          ls -la *.vsix
          node test-extension-bundle.js *.vsix
